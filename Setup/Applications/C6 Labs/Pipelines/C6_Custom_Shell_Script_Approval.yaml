harnessApiVersion: '1.0'
type: PIPELINE
description: https://harnesssupport.zendesk.com/agent/tickets/29543
pipelineStages:
- type: ENV_STATE
  name: helper wf to raise variables
  parallel: false
  skipCondition:
    type: DO_NOT_SKIP
  stageName: Carregar Variaveis Necessarias
  workflowName: helper workflow to raise variables
  workflowVariables:
  - name: change
    value: '12345'
  - entityType: ENVIRONMENT
    name: Environment
    value: dev
  - entityType: SERVICE
    name: Service
    value: C6_Helm_Fake
  - entityType: INFRASTRUCTURE_DEFINITION
    name: InfraDefinition_KUBERNETES
    value: mbp_k8s
  - name: svc_name
    value: ${service.name}
- type: APPROVAL
  name: Approval 1
  parallel: false
  properties:
    approvalStateParams:
      shellScriptApprovalParams:
        scriptString: |-
          cd /root/harness-service-now/

          CHANGE_NUMBER=${workflow.variables.change}
          CMDB_CI_NAME=${workflow.variables.svc_name}
          SNOW_USER=svc_harness_CD
          SNOW_PASS=${secrets.getValue("harness_user")}
          URL_SNOW="https://c6bank.service-now.com"

          echo "########"
          echo "${CHANGE_NUMBER}"
          echo "${CMDB_CI_NAME}"
          echo "${SNOW_USER}"
          echo "${SNOW_PASS}"
          echo "${URL_SNOW}"
          echo "########"

          export HARNESS_APPROVAL_STATUS="APPROVED"
        retryInterval: 30000
        delegateSelectors:
        - ec2-final-sa-east-1
    stageName: Custom Approval
    timeoutMillis: 86400000
    approvalStateType: SHELL_SCRIPT
  skipCondition:
    type: DO_NOT_SKIP
  stageName: Custom Approval
